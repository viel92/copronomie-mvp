# Guide Demarrage Rapide - Deploiement 2 VPS

## Ce qui a ete prepare pour vous

### Fichiers crees
- **DEPLOYMENT_2VPS_STRATEGY.md** : Strategie complete 2 VPS (staging + production)
- **DEPLOYMENT_VPS.md** : Guide detaille setup VPS (existant)
- **apps/api/.env.staging** : Variables environnement API staging
- **apps/web/.env.staging** : Variables environnement Web staging
- **apps/api/.env.production** : Variables environnement API production
- **apps/web/.env.production** : Variables environnement Web production
- **scripts/deploy-staging.sh** : Script deploiement automatise STAGING
- **scripts/deploy-production.sh** : Script deploiement automatise PRODUCTION

### Architecture preparee
```
VPS 1 - STAGING                    VPS 2 - PRODUCTION
├─ staging-app.copronomie.fr       ├─ app.copronomie.fr
├─ staging-api.copronomie.fr       ├─ api.copronomie.fr
├─ Supabase Staging                ├─ Supabase Production
└─ Beta testers (3-5 users)        └─ Clients payants
```

---

## Etape 1: Prerequis AVANT de deployer

### 1.1 - Creer 2 Projets Supabase

**Projet 1 - Staging:**
1. Aller sur https://supabase.com
2. Creer nouveau projet: `copronomie-staging`
3. Noter:
   - URL: `https://xxx.supabase.co`
   - Anon Key: `eyJhbGc...`
   - Service Role Key: `eyJhbGc...`

**Projet 2 - Production:**
1. Creer nouveau projet: `copronomie-production`
2. Noter les memes infos

**Appliquer le schema SQL sur les 2 projets:**
- Aller dans SQL Editor
- Copier/coller le contenu de votre schema SQL initial
- Executer sur chaque projet

### 1.2 - Configurer DNS

Chez votre registrar (OVH, Gandi, Cloudflare, etc.):

| Sous-domaine | Type | Valeur | TTL |
|--------------|------|--------|-----|
| `staging-app.copronomie.fr` | A | `IP_VPS_1` | 300 |
| `staging-api.copronomie.fr` | A | `IP_VPS_1` | 300 |
| `app.copronomie.fr` | A | `IP_VPS_2` | 300 |
| `api.copronomie.fr` | A | `IP_VPS_2` | 300 |

Attendre 5-10 minutes que le DNS se propage.

Verifier:
```bash
nslookup staging-app.copronomie.fr
nslookup app.copronomie.fr
```

### 1.3 - Completer les fichiers .env

**Editer: `apps/api/.env.staging`**
```bash
nano apps/api/.env.staging
```
Remplacer:
- `your-staging-project.supabase.co` par l'URL Supabase staging
- `your-staging-anon-key` par la clef anon Supabase staging
- `your-staging-service-role-key` par la service role key staging
- `re_your_resend_api_key` par votre vraie cle Resend (si vous en avez)

**Editer: `apps/web/.env.staging`**
```bash
nano apps/web/.env.staging
```
Remplacer les memes infos (URL + anon key uniquement).

**Repeter pour .env.production** (avec les infos Supabase production).

### 1.4 - Verifier les VPS

**VPS 1 (Staging):**
- IP: `_______________`
- OS: Ubuntu 22.04 (recommande)
- RAM: 2GB minimum (Hetzner CX11)

**VPS 2 (Production):**
- IP: `_______________`
- OS: Ubuntu 22.04
- RAM: 4GB recommande (Hetzner CX21)

**Acces SSH:**
```bash
ssh root@IP_VPS_1
ssh root@IP_VPS_2
```

---

## Etape 2: Deploiement VPS 1 - STAGING (Aujourd'hui - 2-3h)

### 2.1 - Suivre le guide DEPLOYMENT_VPS.md

Ouvrir `DEPLOYMENT_VPS.md` et suivre TOUTES les etapes:
- Etape 1-4: Setup VPS (user deploy, Docker, Nginx, Git)
- Etape 5: Variables environnement (copier .env.staging)
- Etape 6-9: Build Docker + Nginx + SSL + Demarrage
- Etape 10: Firewall
- Etape 11: Tests

**Commandes principales (resume):**
```bash
# Sur VPS 1
ssh root@IP_VPS_1

# Creer user deploy
adduser deploy
usermod -aG sudo deploy

# Installer Docker + Nginx
sudo apt update && sudo apt upgrade -y
# ... (voir DEPLOYMENT_VPS.md pour details)

# Cloner projet
cd /home/deploy
git clone https://github.com/VOTRE_USERNAME/copronomie-v2.git
cd copronomie-v2

# Copier .env staging (IMPORTANT)
cp apps/api/.env.staging apps/api/.env.production
cp apps/web/.env.staging apps/web/.env.production

# Build et demarrer
docker compose build
docker compose up -d

# Verifier
docker compose logs -f
curl http://localhost:4000/health
```

### 2.2 - Configurer Nginx pour STAGING

**Fichier: `/etc/nginx/sites-available/copronomie-staging`**
```nginx
server {
    listen 80;
    server_name staging-api.copronomie.fr;

    location / {
        proxy_pass http://localhost:4000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 80;
    server_name staging-app.copronomie.fr;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

Activer:
```bash
sudo ln -s /etc/nginx/sites-available/copronomie-staging /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 2.3 - SSL avec Certbot

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d staging-api.copronomie.fr
sudo certbot --nginx -d staging-app.copronomie.fr
```

### 2.4 - Tests STAGING

**Backend:**
```bash
curl https://staging-api.copronomie.fr/health
# Devrait retourner: {"status":"ok"}
```

**Frontend:**
1. Ouvrir https://staging-app.copronomie.fr
2. Creer compte syndic
3. Creer copropriete
4. Creer projet
5. Publier projet

**Workflow complet:**
1. Mode incognito: https://staging-app.copronomie.fr
2. Creer compte entreprise
3. Voir projets disponibles
4. Soumettre devis
5. Verifier email recu (si Resend configure)

Si tout fonctionne: **STAGING EST PRET!**

---

## Etape 3: Deploiement VPS 2 - PRODUCTION (Demain - 1-2h)

### 3.1 - Repeter les memes etapes

**Suivre DEPLOYMENT_VPS.md sur VPS 2:**
- Memes etapes que VPS 1
- Utiliser `.env.production` au lieu de `.env.staging`
- DNS: `app.copronomie.fr` et `api.copronomie.fr`
- Nginx: Meme config mais avec domaines production

**Difference importante:**
- **AUCUNE seed data** en production (DB vide)
- **Tests plus stricts** (workflow complet obligatoire)
- **Monitoring Sentry** (voir section suivante)

### 3.2 - Tests PRODUCTION

**Checklist complete:**
- [ ] https://api.copronomie.fr/health retourne 200
- [ ] https://app.copronomie.fr charge sans erreurs
- [ ] Inscription syndic fonctionne
- [ ] Creation copropriete fonctionne
- [ ] Creation + publication projet fonctionne
- [ ] Inscription company fonctionne
- [ ] Soumission devis fonctionne
- [ ] Email notification recu
- [ ] Acceptation devis fonctionne
- [ ] Dashboard analytics affiche donnees

Si tout fonctionne: **PRODUCTION EST PRET!**

---

## Etape 4: Monitoring (30min)

### 4.1 - Setup Sentry (Gratuit)

1. Creer compte sur https://sentry.io
2. Creer 2 projets:
   - `copronomie-web-production`
   - `copronomie-api-production`
3. Noter les DSN (URLs de configuration)

**Ajouter aux .env production:**
```env
# apps/api/.env.production
SENTRY_DSN=https://xxx@sentry.io/xxx

# apps/web/.env.production
NEXT_PUBLIC_SENTRY_DSN=https://xxx@sentry.io/xxx
```

4. Rebuild et redemarrer production:
```bash
docker compose down
docker compose build
docker compose up -d
```

### 4.2 - UptimeRobot (Optionnel - Gratuit)

1. Creer compte sur https://uptimerobot.com
2. Ajouter monitors:
   - `https://api.copronomie.fr/health` (check toutes les 5min)
   - `https://app.copronomie.fr` (check toutes les 5min)
3. Configurer alertes email si downtime >2min

---

## Etape 5: Scripts de Deploiement (10min)

### 5.1 - Rendre les scripts executables

```bash
chmod +x scripts/deploy-staging.sh
chmod +x scripts/deploy-production.sh
```

### 5.2 - Editer les scripts avec vos IPs

**Fichier: `scripts/deploy-staging.sh`**
- Ligne 11: Remplacer `REMPLACER_PAR_IP_VPS_1` par l'IP reelle

**Fichier: `scripts/deploy-production.sh`**
- Ligne 13: Remplacer `REMPLACER_PAR_IP_VPS_2` par l'IP reelle

### 5.3 - Tester les deploiements automatises

**Deployer sur staging:**
```bash
./scripts/deploy-staging.sh
```

**Deployer sur production:**
```bash
./scripts/deploy-production.sh
```

---

## Commandes Utiles Post-Deploiement

### Voir les logs en temps reel
```bash
ssh deploy@IP_VPS_1
cd /home/deploy/copronomie-v2
docker compose logs -f
```

### Redemarrer un service
```bash
docker compose restart api
docker compose restart web
```

### Mettre a jour le code
**STAGING (automatique):**
```bash
./scripts/deploy-staging.sh
```

**PRODUCTION (avec tag):**
```bash
# Localement: creer un tag
git tag v1.0.1
git push origin v1.0.1

# Deployer
./scripts/deploy-production.sh
# Entrer: v1.0.1
```

### Verifier l'etat des conteneurs
```bash
docker compose ps
docker stats
```

---

## Checklist Finale

### VPS 1 - STAGING
- [ ] VPS cree et accessible SSH
- [ ] DNS `staging-app` et `staging-api` pointe vers VPS 1
- [ ] Docker + Nginx installes
- [ ] Projet clone
- [ ] .env.staging rempli avec vraies valeurs Supabase
- [ ] Images Docker buildees
- [ ] Nginx configure pour staging
- [ ] SSL/HTTPS configure (Certbot)
- [ ] Conteneurs demarres (`docker compose up -d`)
- [ ] Health check OK (`curl staging-api/health`)
- [ ] Workflow complet teste (syndic → company → devis)

### VPS 2 - PRODUCTION
- [ ] VPS cree et accessible SSH
- [ ] DNS `app` et `api` pointe vers VPS 2
- [ ] Docker + Nginx installes
- [ ] Projet clone
- [ ] .env.production rempli avec vraies valeurs Supabase
- [ ] Images Docker buildees
- [ ] Nginx configure pour production
- [ ] SSL/HTTPS configure (Certbot)
- [ ] Conteneurs demarres
- [ ] Health check OK
- [ ] Workflow complet teste
- [ ] Sentry configure et teste
- [ ] UptimeRobot configure (optionnel)

### Scripts et Outils
- [ ] Scripts deploy-staging.sh et deploy-production.sh executables
- [ ] IPs VPS renseignees dans les scripts
- [ ] Test deploiement automatise STAGING OK
- [ ] Test deploiement automatise PRODUCTION OK

---

## Timeline Resumee

| Jour | Tache | Duree | Status |
|------|-------|-------|--------|
| **Jour 1** | Setup VPS 1 (STAGING) | 2-3h | ⏳ A faire |
| **Jour 2** | Setup VPS 2 (PRODUCTION) | 1-2h | ⏳ A faire |
| **Jour 3** | Monitoring + Scripts | 1h | ⏳ A faire |
| **Jour 4** | Inviter beta testers (3-5) | 2h | ⏳ A faire |
| **Jour 5-10** | Collecte feedback beta | - | ⏳ A faire |
| **Jour 11** | Deploiement production v1.0 | 30min | ⏳ A faire |

---

## Support et Troubleshooting

### Probleme: "Cannot connect to Docker daemon"
**Solution:**
```bash
sudo usermod -aG docker $USER
newgrp docker
```

### Probleme: "502 Bad Gateway"
**Solution:**
```bash
# Verifier que conteneurs tournent
docker compose ps

# Verifier logs
docker compose logs api
docker compose logs web

# Redemarrer
docker compose restart
```

### Probleme: "CORS error" dans le navigateur
**Solution:**
Verifier que `CORS_ORIGIN` dans `.env.production` correspond exactement au domaine frontend:
```env
# apps/api/.env.production
CORS_ORIGIN=https://app.copronomie.fr  # PAS de slash a la fin!
```

### Probleme: "SSL certificate error"
**Solution:**
```bash
sudo certbot renew
sudo systemctl reload nginx
```

---

## Prochaines Etapes Apres Deploiement

1. **Semaine 1:** Beta testers sur STAGING (3-5 personnes)
2. **Semaine 2:** Collecte feedback + corrections
3. **Semaine 3:** Deploiement PRODUCTION v1.0
4. **Semaine 4:** Lancement public (LinkedIn, Twitter)
5. **Semaine 5+:** Acquisition clients payants

Voir **ROADMAP.md** pour details complets.

---

## Ressources

- **DEPLOYMENT_VPS.md** : Guide detaille setup VPS (etape par etape)
- **DEPLOYMENT_2VPS_STRATEGY.md** : Strategie complete 2 environnements
- **ROADMAP.md** : Plan complet MVP → Production
- **docker-compose.yml** : Configuration Docker existante
- **Dockerfile** (api + web) : Images Docker optimisees

---

**Derniere mise a jour:** 12 Octobre 2025
**Temps total estime:** 4-6 heures (staging + production + monitoring)

**Bon deploiement!**
