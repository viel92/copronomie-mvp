# Strategie Deploiement 2 VPS - Copronomie v2

## Vue d'ensemble

Utilisation de 2 VPS pour separer les environnements STAGING et PRODUCTION.

```
┌─────────────────────────────────────────────────────────────┐
│                    INFRASTRUCTURE 2 VPS                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  VPS 1 - STAGING (Environnement de test)                    │
│  ├─ staging-app.copronomie.fr (Frontend Next.js)            │
│  ├─ staging-api.copronomie.fr (Backend Hono)                │
│  ├─ Database: Supabase Staging (projet separe)              │
│  ├─ Utilisateurs: Beta testers (3-5 personnes)              │
│  └─ Objectif: Tests, validation features avant prod         │
│                                                              │
│  VPS 2 - PRODUCTION (Environnement stable)                  │
│  ├─ app.copronomie.fr (Frontend Next.js)                    │
│  ├─ api.copronomie.fr (Backend Hono)                        │
│  ├─ Database: Supabase Production                           │
│  ├─ Utilisateurs: Vrais clients payants                     │
│  └─ Objectif: Stabilite maximale, uptime 99.9%              │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## Avantages de cette Architecture

### Separation des Environnements
- **Tests isoles:** Bugs de staging n'impactent pas la production
- **Validation features:** Tester avec beta testers avant release publique
- **Seed data:** Projets demo sur staging sans polluer production
- **Deploys frequents:** 5-10 deploys/jour sur staging, 1-2/semaine sur prod

### Workflow de Developpement Ideal
1. **Developper** en local (localhost)
2. **Deployer** sur STAGING pour tests beta
3. **Valider** avec 2-3 beta testers (1-3 jours)
4. **Deployer** sur PRODUCTION une fois valide
5. **Monitorer** production (Sentry, logs)

### Cout
- **VPS 1 (Staging):** Hetzner CX11 (2GB RAM) - 4 EUR/mois
- **VPS 2 (Production):** Hetzner CX21 (4GB RAM) - 6 EUR/mois
- **Total:** 10 EUR/mois (vs 20-30 EUR Vercel + Railway)

---

## Configuration DNS

Configurer 4 sous-domaines pointant vers vos VPS:

| Sous-domaine | Type | Pointe vers | VPS |
|--------------|------|-------------|-----|
| `staging-app.copronomie.fr` | A | `IP_VPS_1` | VPS 1 |
| `staging-api.copronomie.fr` | A | `IP_VPS_1` | VPS 1 |
| `app.copronomie.fr` | A | `IP_VPS_2` | VPS 2 |
| `api.copronomie.fr` | A | `IP_VPS_2` | VPS 2 |

**Exemple (chez votre registrar - OVH, Gandi, etc.):**
```
# VPS 1 - STAGING
staging-app  IN  A  123.45.67.89
staging-api  IN  A  123.45.67.89

# VPS 2 - PRODUCTION
app          IN  A  98.76.54.32
api          IN  A  98.76.54.32
```

---

## Supabase: 2 Projets Separes (Recommande)

### Option A: 2 Projets Supabase Separes (RECOMMANDE)
**Avantages:**
- Isolation totale des donnees (staging ne peut pas corrompre prod)
- Schema migrations testees sur staging avant prod
- Seed data staging sans impacter prod

**Setup:**
1. Creer 2 projets Supabase:
   - `copronomie-staging` (VPS 1)
   - `copronomie-production` (VPS 2)
2. Appliquer le meme schema SQL sur les 2
3. Seed data test uniquement sur staging

### Option B: 1 Projet Supabase avec RLS Strict
**Avantages:**
- Moins cher (1 seul projet gratuit)
- Partage de certaines donnees (ex: companies)

**Inconvenients:**
- Risque de corruption de donnees prod par staging
- Complexite RLS policies (separer staging vs prod)

**Recommandation:** **Option A** (2 projets) pour MVP. Plus simple et plus sur.

---

## Fichiers .env pour les 2 Environnements

### VPS 1 - STAGING

**Fichier: `apps/api/.env.staging`**
```env
NODE_ENV=production
PORT=4000
FRONTEND_URL=https://staging-app.copronomie.fr

# Supabase Staging
SUPABASE_URL=https://votre-projet-staging.supabase.co
SUPABASE_ANON_KEY=your-staging-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-staging-service-role-key

# CORS
CORS_ORIGIN=https://staging-app.copronomie.fr

# Rate Limiting (plus permissif pour tests)
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=200

# Logs (mode debug pour staging)
LOG_LEVEL=debug

# Resend (meme compte, meme FROM email OK)
RESEND_API_KEY=re_votre_api_key
RESEND_FROM_EMAIL=bonjour@copronomie.fr
```

**Fichier: `apps/web/.env.staging`**
```env
# API Backend Staging
NEXT_PUBLIC_API_URL=https://staging-api.copronomie.fr

# Supabase Staging
NEXT_PUBLIC_SUPABASE_URL=https://votre-projet-staging.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-staging-anon-key

# Next.js
NEXT_TELEMETRY_DISABLED=1
```

---

### VPS 2 - PRODUCTION

**Fichier: `apps/api/.env.production`**
```env
NODE_ENV=production
PORT=4000
FRONTEND_URL=https://app.copronomie.fr

# Supabase Production
SUPABASE_URL=https://votre-projet-production.supabase.co
SUPABASE_ANON_KEY=your-production-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-production-service-role-key

# CORS
CORS_ORIGIN=https://app.copronomie.fr

# Rate Limiting (strict pour production)
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# Logs (mode info pour production)
LOG_LEVEL=info

# Resend
RESEND_API_KEY=re_votre_api_key
RESEND_FROM_EMAIL=bonjour@copronomie.fr
```

**Fichier: `apps/web/.env.production`**
```env
# API Backend Production
NEXT_PUBLIC_API_URL=https://api.copronomie.fr

# Supabase Production
NEXT_PUBLIC_SUPABASE_URL=https://votre-projet-production.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-production-anon-key

# Next.js
NEXT_TELEMETRY_DISABLED=1
```

---

## Workflow de Deploiement

### Deploiement STAGING (VPS 1)
**Quand:** Apres chaque feature complete (5-10x par jour)

```bash
# Sur VPS 1
ssh deploy@IP_VPS_1
cd /home/deploy/copronomie-v2

# Pull derniers changements
git pull origin master

# Copier .env.staging vers .env.production (Docker Compose utilise .env.production)
cp apps/api/.env.staging apps/api/.env.production
cp apps/web/.env.staging apps/web/.env.production

# Rebuild et redemarrer
docker compose down
docker compose build
docker compose up -d

# Verifier
docker compose logs -f
curl https://staging-api.copronomie.fr/health
```

### Deploiement PRODUCTION (VPS 2)
**Quand:** Apres validation sur staging (1-2x par semaine)

```bash
# Sur VPS 2
ssh deploy@IP_VPS_2
cd /home/deploy/copronomie-v2

# IMPORTANT: Toujours deployer depuis un tag Git
git fetch --tags
git checkout v1.0.3  # Version validee sur staging

# Copier .env.production (deja configures)
# Pas besoin de copier, ils sont deja la

# Rebuild et redemarrer
docker compose down
docker compose build
docker compose up -d

# Verifier
docker compose logs -f
curl https://api.copronomie.fr/health
```

---

## Checklist Deploiement Initial

### VPS 1 - STAGING

**Prerequis:**
- [ ] VPS 1 cree (Hetzner CX11 - 2GB RAM minimum)
- [ ] DNS `staging-app.copronomie.fr` et `staging-api.copronomie.fr` configures
- [ ] Supabase projet staging cree
- [ ] Schema SQL applique sur DB staging
- [ ] Seed data test crees (3-5 projets exemple)

**Deploiement:**
- [ ] SSH acces configure (utilisateur `deploy`)
- [ ] Docker + Docker Compose installes
- [ ] Nginx installe
- [ ] Projet clone dans `/home/deploy/copronomie-v2`
- [ ] Fichiers `.env.staging` crees (api + web)
- [ ] Images Docker buildees (`docker compose build`)
- [ ] Nginx configure pour `staging-app` et `staging-api`
- [ ] SSL/HTTPS configure avec Certbot
- [ ] Conteneurs demarres (`docker compose up -d`)
- [ ] Health checks passent (curl staging-api/health)

**Tests:**
- [ ] Inscription syndic fonctionne
- [ ] Creation copropriete fonctionne
- [ ] Creation projet fonctionne
- [ ] Inscription company fonctionne
- [ ] Soumission devis fonctionne
- [ ] Email notification recu (Resend)

---

### VPS 2 - PRODUCTION

**Prerequis:**
- [ ] VPS 2 cree (Hetzner CX21 - 4GB RAM recommande)
- [ ] DNS `app.copronomie.fr` et `api.copronomie.fr` configures
- [ ] Supabase projet production cree
- [ ] Schema SQL applique sur DB production
- [ ] AUCUNE seed data (DB vide pour vrais users)

**Deploiement:**
- [ ] SSH acces configure (utilisateur `deploy`)
- [ ] Docker + Docker Compose installes
- [ ] Nginx installe
- [ ] Projet clone dans `/home/deploy/copronomie-v2`
- [ ] Fichiers `.env.production` crees (api + web)
- [ ] Images Docker buildees (`docker compose build`)
- [ ] Nginx configure pour `app` et `api`
- [ ] SSL/HTTPS configure avec Certbot
- [ ] Conteneurs demarres (`docker compose up -d`)
- [ ] Health checks passent (curl api/health)

**Tests:**
- [ ] Workflow complet valide (syndic → company → award)
- [ ] Monitoring Sentry configure (frontend + backend)
- [ ] Backup automatique configure (scripts cron)
- [ ] Firewall UFW active
- [ ] Rate limiting teste (pas de 429 Too Many Requests)

---

## Monitoring et Maintenance

### VPS 1 - STAGING
**Monitoring leger:**
- Logs Docker Compose (`docker compose logs -f`)
- Pas de monitoring avance necessaire
- Downtime acceptable (si bug, juste redemarrer)

### VPS 2 - PRODUCTION
**Monitoring strict:**
- **Sentry:** Erreurs frontend + backend (gratuit jusqu'a 5k events/mois)
- **Uptime monitoring:** UptimeRobot (gratuit, ping toutes les 5min)
- **Logs:** Winston avec rotation (garder 7 jours)
- **Alertes:** Email si downtime >2min (UptimeRobot)

### Scripts de Deploiement Automatises

**Fichier: `scripts/deploy-staging.sh`**
```bash
#!/bin/bash
set -e

echo "Deploiement STAGING (VPS 1)..."

ssh deploy@IP_VPS_1 << 'ENDSSH'
  cd /home/deploy/copronomie-v2
  git pull origin master
  cp apps/api/.env.staging apps/api/.env.production
  cp apps/web/.env.staging apps/web/.env.production
  docker compose down
  docker compose build
  docker compose up -d
  docker image prune -f
ENDSSH

echo "STAGING deploye avec succes!"
echo "Verifiez: https://staging-app.copronomie.fr"
```

**Fichier: `scripts/deploy-production.sh`**
```bash
#!/bin/bash
set -e

echo "ATTENTION: Deploiement PRODUCTION (VPS 2)"
read -p "Version a deployer (ex: v1.0.3): " VERSION
read -p "Confirmer le deploiement de $VERSION en PRODUCTION? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
  echo "Deploiement annule."
  exit 1
fi

ssh deploy@IP_VPS_2 << ENDSSH
  cd /home/deploy/copronomie-v2
  git fetch --tags
  git checkout $VERSION
  docker compose down
  docker compose build
  docker compose up -d
  docker image prune -f
ENDSSH

echo "PRODUCTION deploye avec succes!"
echo "Version: $VERSION"
echo "Verifiez: https://app.copronomie.fr"
```

Rendre executables:
```bash
chmod +x scripts/deploy-staging.sh
chmod +x scripts/deploy-production.sh
```

---

## Gestion des Secrets

### NE JAMAIS COMMITER:
- `.env.staging`
- `.env.production`
- Cles API Supabase
- Cles API Resend

### Ou stocker les secrets?
**Option A (Simple):** Fichiers `.env` sur VPS uniquement
- Copier manuellement lors du setup initial
- Backup securise (1Password, Bitwarden)

**Option B (Avance):** Variables CI/CD (GitHub Actions)
- Stocker dans GitHub Secrets
- Injecter lors du build
- Plus complexe, necessaire seulement si >5 developpeurs

**Recommandation MVP:** **Option A** (fichiers locaux VPS)

---

## Timeline Deploiement

### Aujourd'hui (4 Oct) - VPS 1 STAGING
**Duree estimee: 2-3 heures**
1. Creer Supabase projet staging (15min)
2. Configurer DNS staging (5min)
3. Setup VPS 1 avec DEPLOYMENT_VPS.md (1h30)
4. Tests workflow complet (30min)

### Demain (5 Oct) - VPS 2 PRODUCTION
**Duree estimee: 1-2 heures**
1. Creer Supabase projet production (15min)
2. Configurer DNS production (5min)
3. Setup VPS 2 (memes etapes que VPS 1) (1h)
4. Tests workflow complet + monitoring (30min)

### Apres-demain (6 Oct) - Beta Testers
1. Inviter 3-5 beta testers sur STAGING
2. Onboarding calls (30min chacun)
3. Collecte feedback (1 semaine)

---

## FAQ

### Puis-je utiliser le meme Supabase pour staging et prod?
**Reponse:** Techniquement oui, mais **fortement deconseillee**. Risque de corruption des donnees production par staging. Le plan gratuit Supabase permet 2 projets, profitez-en.

### Dois-je deployer sur staging ET production simultanement?
**Reponse:** **Non.** Deploiez d'abord sur staging, testez 1-3 jours avec beta testers, puis deployez sur production.

### Puis-je automatiser les deploiements?
**Reponse:** Oui, utilisez les scripts `deploy-staging.sh` et `deploy-production.sh` fournis. Pour aller plus loin, configurez GitHub Actions (non necessaire pour MVP).

### Que faire si staging est down?
**Reponse:** Pas grave, c'est staging. Redemarrez simplement (`docker compose restart`). Les beta testers sont prevenus que staging peut etre instable.

### Que faire si production est down?
**Reponse:** URGENT. Verifiez Sentry, logs Docker, redemarrez si necessaire. Objectif: downtime <5min. Envoyez un email aux utilisateurs si downtime >10min.

---

## Prochaines Etapes

1. **Lire ce document** en entier
2. **Choisir vos VPS** (Hetzner recommande)
3. **Configurer DNS** (4 sous-domaines)
4. **Creer 2 projets Supabase** (staging + production)
5. **Suivre DEPLOYMENT_VPS.md** pour VPS 1 (staging)
6. **Tester workflow complet** sur staging
7. **Repeter pour VPS 2** (production)
8. **Inviter beta testers** sur staging
9. **Deployer sur production** apres validation

Bon deploiement!

---

**Derniere mise a jour:** 12 Octobre 2025
**Temps total estime:** 4-5 heures (staging + production)
