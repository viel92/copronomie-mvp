# Deploiement Copronomie v2 - Resume Executif

## Preparation terminee - Pret a deployer

### Fichiers crees (12 Oct 2025)

**Guides de deploiement:**
- `DEPLOYMENT_2VPS_STRATEGY.md` - Strategie complete 2 VPS
- `DEPLOYMENT_VPS.md` - Guide detaille setup VPS (existant)
- `QUICK_START_DEPLOYMENT.md` - Guide demarrage rapide

**Variables d'environnement:**
- `apps/api/.env.staging` - API staging
- `apps/web/.env.staging` - Web staging
- `apps/api/.env.production` - API production
- `apps/web/.env.production` - Web production

**Scripts de deploiement automatises:**
- `scripts/deploy-staging.sh` - Deploiement auto STAGING
- `scripts/deploy-production.sh` - Deploiement auto PRODUCTION

---

## Architecture Preparee

```
┌─────────────────────────────────────────────────────┐
│  VPS 1 - STAGING (Tests beta)                       │
│  ├─ staging-app.copronomie.fr  (Frontend)           │
│  ├─ staging-api.copronomie.fr  (API)                │
│  └─ 3-5 beta testers                                │
├─────────────────────────────────────────────────────┤
│  VPS 2 - PRODUCTION (Clients payants)               │
│  ├─ app.copronomie.fr  (Frontend)                   │
│  ├─ api.copronomie.fr  (API)                        │
│  └─ Vrais utilisateurs                              │
└─────────────────────────────────────────────────────┘
```

---

## Actions Requises AVANT de deployer

### 1. Creer 2 Projets Supabase
- **Projet 1:** `copronomie-staging`
- **Projet 2:** `copronomie-production`
- Appliquer le schema SQL sur les 2

### 2. Configurer DNS (4 sous-domaines)
```
staging-app.copronomie.fr  →  IP_VPS_1
staging-api.copronomie.fr  →  IP_VPS_1
app.copronomie.fr          →  IP_VPS_2
api.copronomie.fr          →  IP_VPS_2
```

### 3. Completer les fichiers .env
Editer ces 4 fichiers avec vos vraies cles:
- `apps/api/.env.staging`
- `apps/web/.env.staging`
- `apps/api/.env.production`
- `apps/web/.env.production`

Remplacer:
- `your-staging-project.supabase.co` → URL reelle
- `your-staging-anon-key` → Cle anon reelle
- `your-staging-service-role-key` → Service role key reelle
- `re_your_resend_api_key` → Cle Resend reelle (optionnel)

**Repeter pour production avec infos Supabase production.**

---

## Deploiement en 3 Etapes

### Etape 1: VPS 1 - STAGING (2-3h)
1. Ouvrir `QUICK_START_DEPLOYMENT.md`
2. Suivre section "Etape 2: Deploiement VPS 1"
3. Reference complete: `DEPLOYMENT_VPS.md`

**Commandes resumees:**
```bash
# Setup VPS
ssh root@IP_VPS_1
adduser deploy
# ... (voir guides pour details)

# Clone projet
cd /home/deploy
git clone https://github.com/VOTRE_USER/copronomie-v2.git
cd copronomie-v2

# Copier .env staging
cp apps/api/.env.staging apps/api/.env.production
cp apps/web/.env.staging apps/web/.env.production

# Build et demarrer
docker compose build
docker compose up -d
```

**Verifier:**
```bash
curl https://staging-api.copronomie.fr/health
```

### Etape 2: VPS 2 - PRODUCTION (1-2h)
Repeter les memes etapes sur VPS 2 avec:
- `.env.production` au lieu de `.env.staging`
- Domaines `app.copronomie.fr` et `api.copronomie.fr`

### Etape 3: Monitoring (30min)
1. Setup Sentry (https://sentry.io)
2. Ajouter DSN dans `.env.production`
3. Rebuild production

---

## Scripts Automatises (Apres Premier Deploiement)

### Deployer sur STAGING
```bash
./scripts/deploy-staging.sh
```

### Deployer sur PRODUCTION
```bash
./scripts/deploy-production.sh
```

**Note:** Editer les scripts pour renseigner les IPs VPS (lignes 11 et 13).

---

## Timeline Deployment

| Jour | Tache | Duree |
|------|-------|-------|
| **Aujourd'hui** | Preparation .env + guides | FAIT |
| **Demain** | Setup VPS 1 (STAGING) | 2-3h |
| **Apres-demain** | Setup VPS 2 (PRODUCTION) | 1-2h |
| **J+3** | Monitoring + Scripts | 1h |
| **J+4 → J+10** | Beta testers sur STAGING | - |
| **J+11** | Lancement production v1.0 | - |

---

## Commandes Utiles

### Voir les logs
```bash
ssh deploy@IP_VPS
cd /home/deploy/copronomie-v2
docker compose logs -f
```

### Redemarrer
```bash
docker compose restart
```

### Mettre a jour
```bash
./scripts/deploy-staging.sh   # STAGING
./scripts/deploy-production.sh  # PRODUCTION
```

---

## Guides de Reference

1. **QUICK_START_DEPLOYMENT.md** ← Commencer par ici
2. **DEPLOYMENT_2VPS_STRATEGY.md** ← Strategie complete
3. **DEPLOYMENT_VPS.md** ← Guide technique detaille
4. **ROADMAP.md** ← Plan global MVP

---

## Support

**Problemes frequents:**
- CORS error → Verifier `CORS_ORIGIN` dans `.env`
- 502 Bad Gateway → Verifier `docker compose ps`
- Cannot connect to DB → Verifier cles Supabase dans `.env`
- SSL error → Executer `sudo certbot renew`

**Logs:**
```bash
docker compose logs api    # Backend
docker compose logs web    # Frontend
sudo tail -f /var/log/nginx/error.log  # Nginx
```

---

**Status:** Preparation complete - Pret a deployer
**Date:** 12 Octobre 2025
**Prochaine action:** Creer projets Supabase + Configurer DNS

Bon deploiement!
